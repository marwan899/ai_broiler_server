<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุฐูู ููุฑูุฌ ุงููุญู Ross 308</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* (Styles remain the same) */
        body { font-family: 'Cairo', sans-serif; overscroll-behavior-y: contain; background-color: #f7f9fc; }
        .container-fluid { max-width: 1400px; margin: 0 auto; }
        .card { background-color: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .metric-card { background-color: #ffffff; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); border: 1px solid #dbeafe; text-align: center; }
        .metric-value { font-size: 1.75rem; font-weight: 800; color: #1e3a8a; margin-top: 0.5rem; }
        .metric-label { font-size: 0.875rem; color: #4b5563; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        #flock-age-input { width: 100%; text-align: center; border: 2px solid #3b82f6; background-color: #eff6ff; color: #1e3a8a; font-size: 1.75rem !important; padding: 0.25rem 0; }
        input[type="number"], input[type="date"], textarea, .form-input { width: 100%; padding: 0.65rem; border-radius: 8px; border: 1px solid #d1d5db; text-align: right; font-size: 1rem; background-color: #f9fafb; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="dashboard-screen" class="p-4 md:p-8 container-fluid hidden">
        <header class="mb-6 border-b pb-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุฐูู ููุฑูุฌ ุงููุญู (Ross 308)</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="current-breeder-display" class="font-bold text-lg text-indigo-700"></span>
                    <button id="reset-button" class="btn text-sm bg-red-500 hover:bg-red-600">ุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉ</button>
                </div>
            </div>
            <p class="text-base text-gray-500 mt-1">ุชุทููุฑ: <span class="font-semibold text-blue-600">Eng Marwan AL Nasree</span></p>
        </header>

        <div class="card mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ุงููุคุดุฑุงุช ุงูุณุฑูุนุฉ (ุงููุณุชูุฏูุฉ ูุงูุฏููุงููููุฉ)</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-4 gap-4">
                
                <div class="metric-card bg-blue-50">
                    <div class="metric-label font-bold text-blue-700">ุงูุนูุฑ (ููู)</div>
                    <input type="number" id="flock-age-input" class="rounded-lg mt-1" value="0">
                </div>
                <div class="metric-card">
                    <div class="metric-label">ุนูู/ุทูุฑ ุงูููู (ุบุฑุงู)</div>
                    <div id="target-daily-feed" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ุงููุฒู ุงููุชููุน/ุทูุฑ (ุบุฑุงู)</div>
                    <div id="target-weight-grams" class="metric-value">--</div>
                </div>
                <div class="metric-card bg-yellow-50">
                    <div class="metric-label text-yellow-800 font-bold">ูุนุงูู FCR ุงููุณุชูุฏู</div>
                    <div id="target-fcr" class="metric-value text-yellow-800">--</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:col-span-3 gap-6">

            <div class="space-y-6 lg:col-span-2">
                
                <div class="card">
                    <h2 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">ุงูุจูุฆุฉ ูุงูุฃุฏุงุก (ููููู <span id="current-age-display">0</span>)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
                        <div>
                            <div class="metric-label">ุงูุญุฑุงุฑุฉ ุงููุณุชูุฏูุฉ (ยฐู)</div>
                            <div id="target-temp" class="metric-value text-green-700">--</div>
                        </div>
                        <div>
                            <div class="metric-label">ุงูุฑุทูุจุฉ ุงููุณุชูุฏูุฉ (%)</div>
                            <div id="target-humidity" class="metric-value text-green-700">--</div>
                        </div>
                        <div>
                            <div class="metric-label">ุงููุฒู ุงููุชููุน (ุบุฑุงู)</div>
                            <div id="target-weight" class="metric-value text-green-700">--</div>
                        </div>
                         <div>
                            <div class="metric-label text-red-700">ูุณุจุฉ ุงููููู ุงูุฅุฌูุงููุฉ (%)</div>
                            <div id="total-mortality-rate" class="metric-value text-red-700">0%</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="metric-label">ุงูุนูู ุงููุณุชููู ุงููุนูู (ูุบู)</div>
                            <div id="actual-cumulative-feed" class="metric-value text-gray-700 text-xl">--</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="metric-label text-red-600">FCR ุงููุนูู ุงูุชุฑุงููู</div>
                            <div id="actual-fcr" class="metric-value text-red-600 text-xl">--</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ุชุณุฌูู ุจูุงูุงุช ุงูููู</h2>
                    <p id="data-entry-message" class="text-center font-semibold mb-4 hidden"></p>
                    <form id="daily-data-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                         <div class="md:col-span-3">
                            <label for="breeder-name" class="block text-gray-700 font-semibold mb-2">ุงุณู ุงููุฑุจู</label>
                            <input type="text" id="breeder-name" class="form-input bg-gray-200" disabled placeholder="ูุชู ุชุญุฏูุฏู ุนูุฏ ุงูุฅุนุฏุงุฏ ุงูุฃููู">
                        </div>
                        
                        <div id="initial-count-section" class="md:col-span-3 hidden">
                            <label for="initial-chick-count" class="block text-gray-700 font-semibold mb-2 text-indigo-700">ุนุฏุฏ ุงููุทูุน ุงูุฃููู (ูุทููุจ ููุฑุฉ ูุงุญุฏุฉ)</label>
                            <input type="number" id="initial-chick-count" class="form-input border-indigo-500 bg-indigo-50" placeholder="ูุซุงู: 5000">
                        </div>

                        <div class="md:col-span-1">
                            <label for="actual-feed" class="block text-gray-700 font-semibold mb-2">ุงูุนูู ุงููุณุชููู (ูุบู)</label>
                            <input type="number" step="0.1" id="actual-feed" class="form-input" placeholder="ูุซุงู: 150.5">
                        </div>
                        <div class="md:col-span-1">
                            <label for="mortality-count" class="block text-gray-700 font-semibold mb-2">ุนุฏุฏ ุงููุงูู ุงูููู</label>
                            <input type="number" id="mortality-count" class="form-input" value="0">
                        </div>
                        
                        <div class="md:col-span-1">
                            <label for="actual-water" class="block text-gray-700 font-semibold mb-2 text-blue-700">ุงุณุชููุงู ุงููุงุก ุงููููู (ูุชุฑ)</label>
                            <input type="number" step="1" id="actual-water" class="form-input border-blue-500 bg-blue-50" placeholder="ูุซุงู: 350">
                        </div>
                        
                        <div class="md:col-span-1">
                            <label for="actual-weight" class="block text-gray-700 font-semibold mb-2">ูุชูุณุท ูุฒู ุงูุทุงุฆุฑ (ุบุฑุงู)</label>
                            <input type="number" id="actual-weight" class="form-input" placeholder="ูุทููุจ ูู 3-4 ุฃูุงู">
                        </div>
                        
                        <div class="md:col-span-3">
                            <label for="notes" class="block text-gray-700 font-semibold mb-2">ุงูููุงุญุธุงุช/ุงููุดุงูุฏุงุช ุงูููููุฉ</label>
                            <textarea id="notes" rows="3" class="form-input" placeholder="ูุซุงู: ููุญุธ ุงูุฎูุงุถ ุทููู ูู ุงุณุชููุงู ุงููุงุก. ุชู ุฅุนุทุงุก ููุชุงููู C"></textarea>
                        </div>

                        <button type="submit" id="save-daily-data" class="btn btn-primary w-full mt-2 md:col-span-3">ุญูุธ ุจูุงูุงุช ุงูููู</button>
                    </form>
                </div>

            </div>
            
            <div class="space-y-6 lg:col-span-1">
                
                <div class="card bg-indigo-50 border-indigo-200">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4 border-b border-indigo-300 pb-2">๐ก ูุตุงุฆุญ ูุฅุฑุดุงุฏุงุช ุงูููู</h2>
                    <p id="daily-tips-content" class="text-gray-700 leading-relaxed min-h-[100px]">ุณูุชู ุนุฑุถ ุงููุตุงุฆุญ ููุง...</p>
                </div>

                <div class="card text-center bg-green-50 border-green-200">
                    <h2 class="text-xl font-bold text-green-700 mb-4">๐ฉบ ุงููุณุชุดุงุฑ ุงูุตุญู ุงูุฐูู</h2>
                    <p class="text-gray-600 mb-4 text-sm">ุญูู ุงูุฃุนุฑุงุถ ุงููุญุชููุฉ ูููุทูุน ุจุณุฑุนุฉ.</p>
                    <button id="open-ai-modal-btn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700">โจ ุงุณุชุดุงุฑุฉ ููุฑูุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="initial-setup-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">๐ ุฃููุงู ุจู ูู ูุธุงู ุงูุฅุฏุงุฑุฉ ุงูุฐูู</h2>
            <p class="text-gray-700 mb-6">ูุฑุฌู ุฅุฏุฎุงู ุงุณูู (ุฃู ุงุณู ุงููุฒุฑุนุฉ) ููุจุฏุก. ุณูุชู ุฑุจุท ุฌููุน ุจูุงูุงุชู ุจูุฐุง ุงูุงุณู.</p>
            
            <input type="text" id="initial-breeder-name-input" class="form-input w-full p-3 border-blue-500 mb-4 text-center text-xl font-semibold" placeholder="ุฃุฏุฎู ุงุณู ุงููุฑุจู ููุง" required>

            <button id="start-app-btn" class="btn btn-primary w-full">ุจุฏุก ุงูุชุณุฌูู</button>
            <p class="text-red-500 mt-2 hidden" id="setup-error-message">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุตุญูุญ ูุง ููู ุนู 3 ุฃุญุฑู.</p>
        </div>
    </div>
    
    <div id="ai-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ูุตู ุญุงูุฉ ุงููุทูุน</h2>
            <p class="text-gray-600 mb-4">ุงูุชุจ ุจุงูุชูุตูู ุงูุฃุนุฑุงุถ ุงูุชู ุชูุงุญุธูุงุ ูุน ุฐูุฑ ุฃู ุชุบููุฑุงุช ูู ุงูุณููู ุฃู ุงูุดููุฉ.</p>
            <textarea id="symptoms-input" rows="5" class="w-full p-3 border rounded-lg mb-4 text-right" placeholder="ูุซุงู: ุงูุฏุฌุงุฌ ูุนุงูู ูู ุฎููู ูุฅุณูุงู ุฃุจูุถ ูุตุนูุจุฉ ูู ุงูุชููุณ..."></textarea>
            
            <label for="image-input" class="block text-gray-700 font-semibold mb-2">ุฑูุน ุตูุฑุฉ ูููุนุงููุฉ (ุงุฎุชูุงุฑู)</label>
            <input type="file" id="image-input" accept="image/*" class="w-full p-2 border rounded-lg mb-4 text-right bg-gray-50">
            
            <div id="ai-result" class="mt-4 p-3 bg-gray-100 rounded-lg min-h-[100px] text-gray-700 leading-relaxed"></div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="close-ai-modal-btn" class="btn btn-secondary">ุฅุบูุงู</button>
                <button id="analyze-symptoms-btn" class="btn btn-primary">
                    <span id="analyze-btn-text">ุชุญููู ุงูุฃุนุฑุงุถ</span>
                    <span id="analyze-loader" class="loader hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-600 mb-4">ุชุฃููุฏ ุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉ</h2>
            <p class="text-gray-700 mb-6">ูู ุฃูุช ูุชุฃูุฏ ุชูุงููุง ูู ุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉุ <strong>ูุฐุง ุงูุฅุฌุฑุงุก ุณูููู ุจุฅุนุงุฏุฉ ุชุนููู ุจูุงูุงุชู ุจุงููุงูู ูู ุงูุฎุงุฏู ูุงููุงุฌูุฉ.</strong></p>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-reset-btn" class="btn btn-secondary">ุฅูุบุงุก</button>
                <button id="confirm-reset-btn" class="btn btn-danger bg-red-600 hover:bg-red-700">ูุนูุ ุงุจุฏุฃ ุฏูุฑุฉ ุฌุฏูุฏุฉ</button>
            </div>
        </div>
    </div>

<script>
// --- ุงูุจูุงูุงุช ุงูุฅุฑุดุงุฏูุฉ ู ุงูุฅุนุฏุงุฏุงุช ---
const broilerGuideData = [ /* ... */ ];
const DEFAULT_FLOCK_DATA = { /* ... */ };

// ุฑุงุจุท Google Cloud App Engine
const SERVER_URL = 'https://gen-lang-client-0187043650.ew.r.appspot.com'; 
const GEMINI_API_KEY = "AIzaSyDsxvFn9iN_cHZ8ElLKWldYOiWVHgJ5myh"; 

let flockData = {...DEFAULT_FLOCK_DATA};
let currentFlockId = null; 
let currentBreederName = null;

function createFlockId(name) {
    return 'FLOCK_' + btoa(encodeURIComponent(name.trim().toUpperCase()));
}

// ... (ุจููุฉ ุงูุฏูุงู ุงููุณุงุนุฏุฉ) ...

async function loadFlockDataFromServer(flockId) {
    const response = await fetch(`${SERVER_URL}/api/flock/all-data`);
    if (!response.ok) {
        throw new Error(`ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช: ${response.status}`);
    }
    const allData = await response.json();
    
    const flock = allData.find(f => f.flockId === flockId);
    return flock || null;
}

async function saveRecordToServer(record) {
    if (!record.flockId) {
        throw new Error("ูุฌุจ ุชุญุฏูุฏ ูุนุฑูู ุงููุทูุน (flockId) ููุญูุธ.");
    }
    
    const response = await fetch(`${SERVER_URL}/api/records/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(record)
    });

    const result = await response.json();

    if (!response.ok) {
        throw new Error(result.message || "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช ุนูู ุงูุฎุงุฏู.");
    }

    return result; 
}

async function loadData() {
    if (!currentFlockId) return; 

    const breederNameInput = document.getElementById('breeder-name');
    const currentBreederDisplay = document.getElementById('current-breeder-display');
    
    breederNameInput.value = currentBreederName;
    currentBreederDisplay.textContent = `ุงููุฑุจู: ${currentBreederName}`;
    
    // ... (ุจููุฉ ููุทู ุงูุชุญููู) ...
}

// ... (ุจููุฉ ุงูุฏูุงู) ...


function setupApplication() {
    const initialSetupModal = document.getElementById('initial-setup-modal');
    const dashboardScreen = document.getElementById('dashboard-screen');
    
    currentBreederName = localStorage.getItem('breederName');
    
    if (currentBreederName) {
        currentFlockId = createFlockId(currentBreederName);
        initialSetupModal.classList.add('hidden');
        dashboardScreen.classList.remove('hidden');
        loadData();
    } else {
        initialSetupModal.classList.remove('hidden');
        dashboardScreen.classList.add('hidden');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    
    // ----------------------------------------------------
    // *** ุฌูุจ ุฌููุน ุงูุนูุงุตุฑ ุงูุขู ุฏุงุฎู DOMContentLoaded ***
    // ----------------------------------------------------
    const startAppBtn = document.getElementById('start-app-btn');
    const initialBreederNameInput = document.getElementById('initial-breeder-name-input');
    const setupErrorMsg = document.getElementById('setup-error-message');
    const initialSetupModal = document.getElementById('initial-setup-modal');
    const dashboardScreen = document.getElementById('dashboard-screen');
    const breederNameInput = document.getElementById('breeder-name'); 
    const initialCountInputSection = document.getElementById('initial-count-section');
    const initialChickCountInput = document.getElementById('initial-chick-count');
    const actualWaterInput = document.getElementById('actual-water'); 
    const notesInput = document.getElementById('notes');
    const dataEntryMessage = document.getElementById('data-entry-message'); 
    
    // --- ูุนุงูุฌ ุญุฏุซ ุฒุฑ "ุจุฏุก ุงูุชุณุฌูู" (ุงูุชุตุญูุญ ุงูููุงุฆู) ---
    if (startAppBtn) { 
        startAppBtn.addEventListener('click', () => {
            const name = initialBreederNameInput.value.trim();
            if (name.length < 3) {
                setupErrorMsg.classList.remove('hidden');
                return;
            }
            
            currentBreederName = name;
            currentFlockId = createFlockId(currentBreederName);
            localStorage.setItem('breederName', currentBreederName);

            setupErrorMsg.classList.add('hidden');
            initialSetupModal.classList.add('hidden');
            dashboardScreen.classList.remove('hidden'); 
            
            loadData();
        });
    }

    // --- ุชุดุบูู ุงูุฅุนุฏุงุฏ ุงูุฃููู ---
    setupApplication(); 
    
    // ... (ุจููุฉ ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ) ...
});
</script>
</body>
</html>