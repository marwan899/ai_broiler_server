<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام الإدارة الذكي لفروج اللحم Ross 308 — ثابت</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;background:#f7f9fc}
    .container-fluid{max-width:1400px;margin:0 auto}
    .card{background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);border:1px solid #e5e7eb}
    .btn{padding:.75rem 1.5rem;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal-content{background:#fff;padding:2rem;border-radius:12px;max-width:550px;width:90%;max-height:90vh;overflow:auto}
    .shake{animation:shake .25s linear 2}@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-6px)}100%{transform:translateX(0)}}
  </style>
</head>
<body class="bg-gray-100">
  <div id="dashboard-screen" class="p-4 md:p-8 container-fluid hidden">
    <header class="mb-6 border-b pb-4">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">نظام الإدارة الذكي لفروج اللحم (Ross 308)</h1>
        <div class="flex items-center gap-3">
          <span id="current-breeder-display" class="font-bold text-lg text-indigo-700"></span>
          <button id="reset-button" class="btn bg-red-500 hover:bg-red-600 text-white text-sm">بدء دورة جديدة</button>
        </div>
      </div>
      <p class="text-base text-gray-500 mt-1">تطوير: <span class="font-semibold text-blue-600">Eng Marwan AL Nasree</span></p>
    </header>

    <div class="card">
      <h2 class="text-xl font-bold text-gray-800 mb-4">🎛️ لوحة بسيطة للتأكد من التشغيل</h2>
      <p class="mb-2 text-gray-600">إذا تشوف هاي الشاشة، فـ زر <b>بدء التسجيل</b> اشتغل تمام وانحفظ اسمك.</p>
      <div class="text-sm text-gray-700">العمر الحالي: <span id="current-age-display">0</span> يوم</div>
    </div>
  </div>

  <div id="initial-setup-modal" class="modal-overlay">
    <div class="modal-content text-center">
      <h2 class="text-2xl font-bold text-blue-600 mb-4">👋 أهلاً بك</h2>
      <p class="text-gray-700 mb-6">أدخل اسمك (أو اسم المزرعة) للبدء.</p>
      <input type="text" id="initial-breeder-name-input" class="w-full p-3 border rounded-lg border-blue-500 mb-3 text-center text-xl font-semibold" placeholder="أدخل اسم المربي هنا" required>
      <button id="start-app-btn" class="btn btn-primary w-full">بدء التسجيل</button>
      <p id="setup-error-message" class="text-red-600 mt-3 hidden">الرجاء إدخال اسم صحيح لا يقل عن 3 أحرف.</p>
      <p id="debug-hint" class="text-xs text-gray-500 mt-3">Debug: إذا ما اشتغل، افتح Console ودوّر على رسائل LEX-Q.</p>
    </div>
  </div>

  <div id="confirm-reset-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold text-red-600 mb-4">تأكيد بدء دورة جديدة</h2>
      <p class="text-gray-700 mb-6">سيتم مسح الإعداد المحلي والعودة لشاشة البداية.</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-reset-btn" class="btn">إلغاء</button>
        <button id="confirm-reset-btn" class="btn bg-red-600 hover:bg-red-700 text-white">نعم</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Helpers
      const $ = (sel) => document.querySelector(sel);
      const show = (el) => el.classList.remove('hidden');
      const hide = (el) => el.classList.add('hidden');
      const safeSetLS = (k, v) => { try { localStorage.setItem(k, v); } catch(e) { console.warn('LocalStorage blocked', e); } };
      const safeGetLS = (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } };
      const safeDelLS = (k) => { try { localStorage.removeItem(k); } catch(e) { } };

      let currentBreederName = null;

      function createFlockId(name) {
        try { return 'FLOCK_' + btoa(name.trim().toUpperCase()); }
        catch { return 'FLOCK_' + encodeURIComponent(name.trim().toUpperCase()); }
      }

      function bootToDashboard(name) {
        currentBreederName = name;
        $('#current-breeder-display').textContent = 'المربي: ' + currentBreederName;
        hide($('#initial-setup-modal'));
        show($('#dashboard-screen'));
        console.log('[LEX-Q] Booted → Dashboard with name:', currentBreederName);
      }

      // Initial state
      document.addEventListener('DOMContentLoaded', () => {
        const stored = safeGetLS('breederName');
        if (stored && stored.length >= 3) {
          bootToDashboard(stored);
        } else {
          show($('#initial-setup-modal'));
          hide($('#dashboard-screen'));
          console.log('[LEX-Q] Waiting for user name...');
        }
      });

      // SUPER DEFENSIVE: event delegation for Start button
      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t) return;

        // Start button
        if (t.id === 'start-app-btn') {
          const input = $('#initial-breeder-name-input');
          const err = $('#setup-error-message');
          const name = (input.value || '').trim();

          if (name.length < 3) {
            err.classList.remove('hidden');
            input.classList.add('shake');
            setTimeout(() => input.classList.remove('shake'), 350);
            console.warn('[LEX-Q] Invalid name length');
            return;
          }
          err.classList.add('hidden');

          safeSetLS('breederName', name);
          const flockId = createFlockId(name);
          console.log('[LEX-Q] Start clicked → name:', name, 'flockId:', flockId);
          bootToDashboard(name);
        }

        // Reset flow
        if (t.id === 'reset-button') {
          show($('#confirm-reset-modal'));
        }
        if (t.id === 'cancel-reset-btn') {
          hide($('#confirm-reset-modal'));
        }
        if (t.id === 'confirm-reset-btn') {
          safeDelLS('breederName');
          hide($('#confirm-reset-modal'));
          hide($('#dashboard-screen'));
          show($('#initial-setup-modal'));
          console.log('[LEX-Q] Cycle reset done; back to start screen.');
        }
      });

      // Enter key to submit
      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' && !$('#dashboard-screen').classList.contains('hidden')) return;
        if (ev.key === 'Enter') {
          const btn = $('#start-app-btn');
          if (btn) btn.click();
        }
      });
    })();
  </script>
</body>
</html>
