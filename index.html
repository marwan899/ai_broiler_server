<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <style>
        /* (Styles remain the same) */
        body { font-family: 'Cairo', sans-serif; overscroll-behavior-y: contain; background-color: #f7f9fc; }
        .container-fluid { max-width: 1400px; margin: 0 auto; }
        .card { background-color: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .metric-card { background-color: #ffffff; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); border: 1px solid #dbeafe; text-align: center; }
        .metric-value { font-size: 1.75rem; font-weight: 800; color: #1e3a8a; margin-top: 0.5rem; }
        .metric-label { font-size: 0.875rem; color: #4b5563; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        #flock-age-input { width: 100%; text-align: center; border: 2px solid #3b82f6; background-color: #eff6ff; color: #1e3a8a; font-size: 1.75rem !important; padding: 0.25rem 0; }
        input[type="number"], input[type="date"], textarea, .form-input { width: 100%; padding: 0.65rem; border-radius: 8px; border: 1px solid #d1d5db; text-align: right; font-size: 1rem; background-color: #f9fafb; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <script>
// --- البيانات الإرشادية و الإعدادات (تبقى كما هي) ---
const broilerGuideData = [ /* ... */ ];
const DEFAULT_FLOCK_DATA = { /* ... */ };
const SERVER_URL = ''; 
const GEMINI_API_KEY = "AIzaSyDsxvFn9iN_cHZ8ElLKWldYOiWVHgJ5myh"; 

let flockData = {...DEFAULT_FLOCK_DATA};
let currentFlockId = null; 
let currentBreederName = null;

const initialSetupModal = document.getElementById('initial-setup-modal');
const dashboardScreen = document.getElementById('dashboard-screen');
const startAppBtn = document.getElementById('start-app-btn');
const initialBreederNameInput = document.getElementById('initial-breeder-name-input');
const setupErrorMsg = document.getElementById('setup-error-message');


function createFlockId(name) {
    return 'FLOCK_' + btoa(name.trim().toUpperCase());
}

// ... (بقية الدوال المساعدة) ...

// --- الدالة الحاسمة: loadFlockDataFromServer (تم تصحيح المسار) ---
async function loadFlockDataFromServer(flockId) {
    // المسار الموحد
    const response = await fetch(`/api/flock/all-data`);
    if (!response.ok) {
        throw new Error(`فشل في جلب البيانات: ${response.status}`);
    }
    const allData = await response.json();
    
    const flock = allData.find(f => f.flockId === flockId);
    return flock || null;
}

// --- الدالة الحاسمة: saveRecordToServer (تم تصحيح المسار) ---
async function saveRecordToServer(record) {
    if (!record.flockId) {
        throw new Error("يجب تحديد معرّف القطيع (flockId) للحفظ.");
    }
    
    // المسار الموحد
    const response = await fetch(`/api/records/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(record)
    });

    const result = await response.json();

    if (!response.ok) {
        throw new Error(result.message || "حدث خطأ غير معروف أثناء حفظ البيانات على الخادم.");
    }

    return result; 
}


// --- منطق الإعداد الأولي (تم تصحيح موضع معالج الحدث) ---
function setupApplication() {
    currentBreederName = localStorage.getItem('breederName');
    
    if (currentBreederName) {
        currentFlockId = createFlockId(currentBreederName);
        initialSetupModal.classList.add('hidden');
        dashboardScreen.classList.remove('hidden');
        loadData();
    } else {
        initialSetupModal.classList.remove('hidden');
        dashboardScreen.classList.add('hidden');
    }
}

// ... (بقية معالجات الأحداث تبقى كما هي، بما في ذلك startAppBtn.onclick) ...

document.addEventListener('DOMContentLoaded', () => {
    // ... (جلب العناصر) ...
    setupApplication(); 
});
</script>
</body>
</html>
