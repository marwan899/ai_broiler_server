<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ Ù„ÙØ±ÙˆØ¬ Ø§Ù„Ù„Ø­Ù… Ross 308</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* (Styles remain the same) */
        body { font-family: 'Cairo', sans-serif; overscroll-behavior-y: contain; background-color: #f7f9fc; }
        .container-fluid { max-width: 1400px; margin: 0 auto; }
        .card { background-color: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; }
        .metric-card { background-color: #ffffff; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); border: 1px solid #dbeafe; text-align: center; }
        .metric-value { font-size: 1.75rem; font-weight: 800; color: #1e3a8a; margin-top: 0.5rem; }
        .metric-label { font-size: 0.875rem; color: #4b5563; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        #flock-age-input { width: 100%; text-align: center; border: 2px solid #3b82f6; background-color: #eff6ff; color: #1e3a8a; font-size: 1.75rem !important; padding: 0.25rem 0; }
        input[type="number"], input[type="date"], textarea, .form-input { width: 100%; padding: 0.65rem; border-radius: 8px; border: 1px solid #d1d5db; text-align: right; font-size: 1rem; background-color: #f9fafb; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="dashboard-screen" class="p-4 md:p-8 container-fluid hidden">
        <header class="mb-6 border-b pb-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ Ù„ÙØ±ÙˆØ¬ Ø§Ù„Ù„Ø­Ù… (Ross 308)</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span id="current-breeder-display" class="font-bold text-lg text-indigo-700"></span>
                    <button id="reset-button" class="btn text-sm bg-red-500 hover:bg-red-600">Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            </div>
            <p class="text-base text-gray-500 mt-1">ØªØ·ÙˆÙŠØ±: <span class="font-semibold text-blue-600">Eng Marwan AL Nasree</span></p>
        </header>

        <div class="card mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙˆØ§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-4 gap-4">
                
                <div class="metric-card bg-blue-50">
                    <div class="metric-label font-bold text-blue-700">Ø§Ù„Ø¹Ù…Ø± (ÙŠÙˆÙ…)</div>
                    <input type="number" id="flock-age-input" class="rounded-lg mt-1" value="0">
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ø¹Ù„Ù/Ø·ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (ØºØ±Ø§Ù…)</div>
                    <div id="target-daily-feed" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹/Ø·ÙŠØ± (ØºØ±Ø§Ù…)</div>
                    <div id="target-weight-grams" class="metric-value">--</div>
                </div>
                <div class="metric-card bg-yellow-50">
                    <div class="metric-label text-yellow-800 font-bold">Ù…Ø¹Ø§Ù…Ù„ FCR Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</div>
                    <div id="target-fcr" class="metric-value text-yellow-800">--</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:col-span-3 gap-6">

            <div class="space-y-6 lg:col-span-2">
                
                <div class="card">
                    <h2 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡ (Ù„Ù„ÙŠÙˆÙ… <span id="current-age-display">0</span>)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
                        <div>
                            <div class="metric-label">Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Â°Ù…)</div>
                            <div id="target-temp" class="metric-value text-green-700">--</div>
                        </div>
                        <div>
                            <div class="metric-label">Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (%)</div>
                            <div id="target-humidity" class="metric-value text-green-700">--</div>
                        </div>
                        <div>
                            <div class="metric-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØºØ±Ø§Ù…)</div>
                            <div id="target-weight" class="metric-value text-green-700">--</div>
                        </div>
                         <div>
                            <div class="metric-label text-red-700">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†ÙÙˆÙ‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (%)</div>
                            <div id="total-mortality-rate" class="metric-value text-red-700">0%</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="metric-label">Ø§Ù„Ø¹Ù„Ù Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ (ÙƒØºÙ…)</div>
                            <div id="actual-cumulative-feed" class="metric-value text-gray-700 text-xl">--</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="metric-label text-red-600">FCR Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</div>
                            <div id="actual-fcr" class="metric-value text-red-600 text-xl">--</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
                    <p id="data-entry-message" class="text-center font-semibold mb-4 hidden"></p>
                    <form id="daily-data-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                         <div class="md:col-span-3">
                            <label for="breeder-name" class="block text-gray-700 font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø¨ÙŠ</label>
                            <input type="text" id="breeder-name" class="form-input bg-gray-200" disabled placeholder="ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ">
                        </div>
                        
                        <div id="initial-count-section" class="md:col-span-3 hidden">
                            <label for="initial-chick-count" class="block text-gray-700 font-semibold mb-2 text-indigo-700">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</label>
                            <input type="number" id="initial-chick-count" class="form-input border-indigo-500 bg-indigo-50" placeholder="Ù…Ø«Ø§Ù„: 5000">
                        </div>

                        <div class="md:col-span-1">
                            <label for="actual-feed" class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¹Ù„Ù Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ (ÙƒØºÙ…)</label>
                            <input type="number" step="0.1" id="actual-feed" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 150.5">
                        </div>
                        <div class="md:col-span-1">
                            <label for="mortality-count" class="block text-gray-700 font-semibold mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§ÙÙ‚ Ø§Ù„ÙŠÙˆÙ…</label>
                            <input type="number" id="mortality-count" class="form-input" value="0">
                        </div>
                        
                        <div class="md:col-span-1">
                            <label for="actual-water" class="block text-gray-700 font-semibold mb-2 text-blue-700">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ù„ØªØ±)</label>
                            <input type="number" step="1" id="actual-water" class="form-input border-blue-500 bg-blue-50" placeholder="Ù…Ø«Ø§Ù„: 350">
                        </div>
                        
                        <div class="md:col-span-1">
                            <label for="actual-weight" class="block text-gray-700 font-semibold mb-2">Ù…ØªÙˆØ³Ø· ÙˆØ²Ù† Ø§Ù„Ø·Ø§Ø¦Ø± (ØºØ±Ø§Ù…)</label>
                            <input type="number" id="actual-weight" class="form-input" placeholder="Ù…Ø·Ù„ÙˆØ¨ ÙƒÙ„ 3-4 Ø£ÙŠØ§Ù…">
                        </div>
                        
                        <div class="md:col-span-3">
                            <label for="notes" class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                            <textarea id="notes" rows="3" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ù„ÙˆØ­Ø¸ Ø§Ù†Ø®ÙØ§Ø¶ Ø·ÙÙŠÙ ÙÙŠ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¡. ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ ÙÙŠØªØ§Ù…ÙŠÙ† C"></textarea>
                        </div>

                        <button type="submit" id="save-daily-data" class="btn btn-primary w-full mt-2 md:col-span-3">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
                    </form>
                </div>

            </div>
            
            <div class="space-y-6 lg:col-span-1">
                
                <div class="card bg-indigo-50 border-indigo-200">
                    <h2 class="text-xl font-bold text-indigo-800 mb-4 border-b border-indigo-300 pb-2">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ ÙˆØ¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
                    <p id="daily-tips-content" class="text-gray-700 leading-relaxed min-h-[100px]">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ù‡Ù†Ø§...</p>
                </div>

                <div class="card text-center bg-green-50 border-green-200">
                    <h2 class="text-xl font-bold text-green-700 mb-4">ğŸ©º Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h2>
                    <p class="text-gray-600 mb-4 text-sm">Ø­Ù„Ù„ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ù‚Ø·ÙŠØ¹ Ø¨Ø³Ø±Ø¹Ø©.</p>
                    <button id="open-ai-modal-btn" class="btn btn-primary w-full bg-green-600 hover:bg-green-700">âœ¨ Ø§Ø³ØªØ´Ø§Ø±Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="initial-setup-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ</h2>
            <p class="text-gray-700 mb-6">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ (Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø±Ø¹Ø©) Ù„Ù„Ø¨Ø¯Ø¡. Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….</p>
            
            <input type="text" id="initial-breeder-name-input" class="form-input w-full p-3 border-blue-500 mb-4 text-center text-xl font-semibold" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø¨ÙŠ Ù‡Ù†Ø§" required>

            <button id="start-app-btn" class="btn btn-primary w-full">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <p class="text-red-500 mt-2 hidden" id="setup-error-message">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 3 Ø£Ø­Ø±Ù.</p>
        </div>
    </div>
    
    <div id="ai-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ÙˆØµÙ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø·ÙŠØ¹</h2>
            <p class="text-gray-600 mb-4">Ø§ÙƒØªØ¨ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„ØªÙŠ ØªÙ„Ø§Ø­Ø¸Ù‡Ø§ØŒ Ù…Ø¹ Ø°ÙƒØ± Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø£Ùˆ Ø§Ù„Ø´Ù‡ÙŠØ©.</p>
            <textarea id="symptoms-input" rows="5" class="w-full p-3 border rounded-lg mb-4 text-right" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¯Ø¬Ø§Ø¬ ÙŠØ¹Ø§Ù†ÙŠ Ù…Ù† Ø®Ù…ÙˆÙ„ ÙˆØ¥Ø³Ù‡Ø§Ù„ Ø£Ø¨ÙŠØ¶ ÙˆØµØ¹ÙˆØ¨Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙØ³..."></textarea>
            
            <label for="image-input" class="block text-gray-700 font-semibold mb-2">Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" id="image-input" accept="image/*" class="w-full p-2 border rounded-lg mb-4 text-right bg-gray-50">
            
            <div id="ai-result" class="mt-4 p-3 bg-gray-100 rounded-lg min-h-[100px] text-gray-700 leading-relaxed"></div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="close-ai-modal-btn" class="btn btn-secondary">Ø¥ØºÙ„Ø§Ù‚</button>
                <button id="analyze-symptoms-btn" class="btn btn-primary">
                    <span id="analyze-btn-text">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</span>
                    <span id="analyze-loader" class="loader hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <p class="text-gray-700 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ù‹Ø§ Ù…Ù† Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ <strong>Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©.</strong></p>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-reset-btn" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirm-reset-btn" class="btn btn-danger bg-red-600 hover:bg-red-700">Ù†Ø¹Ù…ØŒ Ø§Ø¨Ø¯Ø£ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </div>
    </div>

<script>
// --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© Ù„ÙØ±ÙˆØ¬ Ø§Ù„Ù„Ø­Ù… (Ross 308 Standards) ---
const broilerGuideData = [
    { day: 0, weight: 42, dailyFeed: 0, cumulativeFeed: 0, fcr: 0, temp: 33, humidity: 65 },
    { day: 1, weight: 55, dailyFeed: 12, cumulativeFeed: 12, fcr: 0.92, temp: 33, humidity: 65 },
    { day: 2, weight: 70, dailyFeed: 15, cumulativeFeed: 27, fcr: 0.96, temp: 33, humidity: 65 },
    { day: 3, weight: 88, dailyFeed: 18, cumulativeFeed: 45, fcr: 1.00, temp: 32, humidity: 65 },
    { day: 4, weight: 110, dailyFeed: 22, cumulativeFeed: 67, fcr: 1.02, temp: 32, humidity: 65 },
    { day: 5, weight: 135, dailyFeed: 25, cumulativeFeed: 92, fcr: 1.04, temp: 31, humidity: 65 },
    { day: 6, weight: 160, dailyFeed: 28, cumulativeFeed: 120, fcr: 1.06, temp: 31, humidity: 65 },
    { day: 7, weight: 188, dailyFeed: 32, cumulativeFeed: 152, fcr: 1.08, temp: 30, humidity: 60 },
    { day: 8, weight: 220, dailyFeed: 36, cumulativeFeed: 188, fcr: 1.10, temp: 30, humidity: 60 },
    { day: 9, weight: 255, dailyFeed: 40, cumulativeFeed: 228, fcr: 1.12, temp: 30, humidity: 60 },
    { day: 10, weight: 295, dailyFeed: 45, cumulativeFeed: 273, fcr: 1.14, temp: 29, humidity: 60 },
    { day: 11, weight: 340, dailyFeed: 50, cumulativeFeed: 323, fcr: 1.16, temp: 29, humidity: 60 },
    { day: 12, weight: 385, dailyFeed: 55, cumulativeFeed: 378, fcr: 1.18, temp: 29, humidity: 60 },
    { day: 13, weight: 435, dailyFeed: 60, cumulativeFeed: 438, fcr: 1.20, temp: 28, humidity: 55 },
    { day: 14, weight: 488, dailyFeed: 65, cumulativeFeed: 503, fcr: 1.22, temp: 28, humidity: 55 },
    { day: 15, weight: 545, dailyFeed: 70, cumulativeFeed: 573, fcr: 1.24, temp: 28, humidity: 55 },
    { day: 16, weight: 605, dailyFeed: 76, cumulativeFeed: 649, fcr: 1.26, temp: 27, humidity: 55 },
    { day: 17, weight: 670, dailyFeed: 82, cumulativeFeed: 731, fcr: 1.28, temp: 27, humidity: 55 },
    { day: 18, weight: 735, dailyFeed: 88, cumulativeFeed: 819, fcr: 1.30, temp: 27, humidity: 55 },
    { day: 19, weight: 805, dailyFeed: 94, cumulativeFeed: 913, fcr: 1.32, temp: 26, humidity: 55 },
    { day: 20, weight: 880, dailyFeed: 100, cumulativeFeed: 1013, fcr: 1.34, temp: 26, humidity: 55 },
    { day: 21, weight: 955, dailyFeed: 106, cumulativeFeed: 1119, fcr: 1.36, temp: 26, humidity: 55 },
    { day: 22, weight: 1035, dailyFeed: 112, cumulativeFeed: 1231, fcr: 1.38, temp: 25, humidity: 60 },
    { day: 23, weight: 1115, dailyFeed: 118, cumulativeFeed: 1349, fcr: 1.40, temp: 25, humidity: 60 },
    { day: 24, weight: 1200, dailyFeed: 124, cumulativeFeed: 1473, fcr: 1.42, temp: 25, humidity: 60 },
    { day: 25, weight: 1285, dailyFeed: 130, cumulativeFeed: 1603, fcr: 1.44, temp: 24, humidity: 60 },
    { day: 26, weight: 1375, dailyFeed: 136, cumulativeFeed: 1739, fcr: 1.46, temp: 24, humidity: 60 },
    { day: 27, weight: 1465, dailyFeed: 142, cumulativeFeed: 1881, fcr: 1.48, temp: 24, humidity: 60 },
    { day: 28, weight: 1560, dailyFeed: 148, cumulativeFeed: 2029, fcr: 1.50, temp: 23, humidity: 60 },
    { day: 29, weight: 1655, dailyFeed: 153, cumulativeFeed: 2182, fcr: 1.52, temp: 23, humidity: 65 },
    { day: 30, weight: 1750, dailyFeed: 158, cumulativeFeed: 2340, fcr: 1.54, temp: 23, humidity: 65 },
    { day: 31, weight: 1850, dailyFeed: 163, cumulativeFeed: 2503, fcr: 1.56, temp: 22, humidity: 65 },
    { day: 32, weight: 1950, dailyFeed: 168, cumulativeFeed: 2671, fcr: 1.58, temp: 22, humidity: 65 },
    { day: 33, weight: 2050, dailyFeed: 172, cumulativeFeed: 2843, fcr: 1.60, temp: 22, humidity: 65 },
    { day: 34, weight: 2150, dailyFeed: 176, cumulativeFeed: 3019, fcr: 1.62, temp: 21, humidity: 70 },
    { day: 35, weight: 2250, dailyFeed: 180, cumulativeFeed: 3199, fcr: 1.64, temp: 21, humidity: 70 },
    { day: 36, weight: 2350, dailyFeed: 184, cumulativeFeed: 3383, fcr: 1.66, temp: 21, humidity: 70 },
    { day: 37, weight: 2450, dailyFeed: 188, cumulativeFeed: 3571, fcr: 1.68, temp: 21, humidity: 70 },
    { day: 38, weight: 2550, dailyFeed: 191, cumulativeFeed: 3762, fcr: 1.70, temp: 20, humidity: 70 },
    { day: 39, weight: 2650, dailyFeed: 194, cumulativeFeed: 3956, fcr: 1.72, temp: 20, humidity: 70 },
    { day: 40, weight: 2750, dailyFeed: 197, cumulativeFeed: 4153, fcr: 1.74, temp: 20, humidity: 70 },
    { day: 41, weight: 2840, dailyFeed: 200, cumulativeFeed: 4353, fcr: 1.76, temp: 20, humidity: 70 },
    { day: 42, weight: 2930, dailyFeed: 202, cumulativeFeed: 4555, fcr: 1.78, temp: 20, humidity: 70 },
    { day: 43, weight: 3020, dailyFeed: 204, cumulativeFeed: 4759, fcr: 1.80, temp: 20, humidity: 70 },
    { day: 44, weight: 3110, dailyFeed: 206, cumulativeFeed: 4965, fcr: 1.82, temp: 20, humidity: 70 },
    { day: 45, weight: 3200, dailyFeed: 208, cumulativeFeed: 5173, fcr: 1.84, temp: 20, humidity: 70 },
    { day: 46, weight: 3290, dailyFeed: 210, cumulativeFeed: 5383, fcr: 1.86, temp: 20, humidity: 70 },
    { day: 47, weight: 3380, dailyFeed: 212, cumulativeFeed: 5595, fcr: 1.88, temp: 20, humidity: 70 },
    { day: 48, weight: 3470, dailyFeed: 214, cumulativeFeed: 5809, fcr: 1.90, temp: 20, humidity: 70 },
    { day: 49, weight: 3560, dailyFeed: 216, cumulativeFeed: 6025, fcr: 1.92, temp: 20, humidity: 70 },
    { day: 50, weight: 3650, dailyFeed: 218, cumulativeFeed: 6243, fcr: 1.94, temp: 20, humidity: 70 },
    { day: 51, weight: 3740, dailyFeed: 220, cumulativeFeed: 6463, fcr: 1.96, temp: 20, humidity: 70 },
    { day: 52, weight: 3830, dailyFeed: 220, cumulativeFeed: 6683, fcr: 1.98, temp: 20, humidity: 70 },
    { day: 53, weight: 3920, dailyFeed: 221, cumulativeFeed: 6904, fcr: 2.00, temp: 20, humidity: 70 },
    { day: 54, weight: 4010, dailyFeed: 221, cumulativeFeed: 7125, fcr: 2.02, temp: 20, humidity: 70 },
    { day: 55, weight: 4100, dailyFeed: 222, cumulativeFeed: 7347, fcr: 2.04, temp: 20, humidity: 70 },
    { day: 56, weight: 4190, dailyFeed: 222, cumulativeFeed: 7569, fcr: 2.06, temp: 20, humidity: 70 },
    { day: 57, weight: 4280, dailyFeed: 223, cumulativeFeed: 7792, fcr: 2.08, temp: 20, humidity: 70 },
    { day: 58, weight: 4370, dailyFeed: 223, cumulativeFeed: 8015, fcr: 2.10, temp: 20, humidity: 70 },
    { day: 59, weight: 4460, dailyFeed: 224, cumulativeFeed: 8239, fcr: 2.12, temp: 20, humidity: 70 },
    { day: 60, weight: 4550, dailyFeed: 224, cumulativeFeed: 8463, fcr: 2.14, temp: 20, humidity: 70 },
];

const DEFAULT_FLOCK_DATA = {
    startWeight: 42,         
    startDate: new Date().toISOString().split('T')[0], 
    currentAge: 0,
    initialChickCount: 0, 
    dailyRecords: [] 
};

// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆØ§Ù„Ø±Ø¨Ø· ---
const SERVER_URL = ''; 
const GEMINI_API_KEY = "AIzaSyDsxvFn9iN_cHZ8ElLKWldYOiWVHgJ5myh"; 
// ----------------------------------------

let flockData = {...DEFAULT_FLOCK_DATA};
let currentFlockId = null; 
let currentBreederName = null;

const initialSetupModal = document.getElementById('initial-setup-modal');
const dashboardScreen = document.getElementById('dashboard-screen');
const startAppBtn = document.getElementById('start-app-btn');
const initialBreederNameInput = document.getElementById('initial-breeder-name-input');
const setupErrorMsg = document.getElementById('setup-error-message');


function createFlockId(name) {
    return 'FLOCK_' + btoa(name.trim().toUpperCase());
}

function getDailyTips(age) {
    const maxAge = broilerGuideData.length - 1;
    const safeAge = Math.min(Math.max(0, age), maxAge);
    const guide = broilerGuideData[safeAge];
    
    if (!guide) return "ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø¯Ù„ÙŠÙ„ Ross 308. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„Ø­ØµØ§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.";

    if (safeAge <= 3) {
        return `Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ ÙØªØ±Ø© Ø§Ù„ØªØ­Ø¶ÙŠÙ†: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø«Ø§Ø¨ØªØ© Ø¹Ù†Ø¯ ${guide.temp}Â°Ù…ØŒ ÙˆØ£Ù† Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø§Ø¡ Ù…ØªØ§Ø­ Ø¨Ø³Ù‡ÙˆÙ„Ø©. ØªØ­ÙÙŠØ² Ø§Ù„Ø·ÙŠÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒÙ„ ÙˆØ§Ù„Ø´Ø±Ø¨ Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹.`;
    } else if (safeAge <= 7) {
        return "Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ Ø­Ø§Ø³Ù…. ÙŠØ¬Ø¨ ÙØ­Øµ Ø§Ù„ÙØ±Ø´Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙˆØ¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¨Ù„Ù„. Ø±Ø§Ù‚Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†ÙÙˆÙ‚ (Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©) ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (<1%).";
    } else if (safeAge <= 14) {
        return "Ø§Ø¨Ø¯Ø£ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ‡ÙˆÙŠØ© ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡. ÙˆØ³Ù‘Ø¹ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø­Ø¶Ø§Ù†Ø© Ø¨Ø¨Ø·Ø¡ Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù….";
    } else if (safeAge <= 21) {
        return "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø³Ø±ÙŠØ¹: ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØ§ÙØ± Ø§Ù„Ø¹Ù„Ù Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©. Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‡ÙˆÙŠØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„ÙƒØ§ÙÙŠ Ù„Ù„Ù†Ù…Ùˆ ÙˆØªØ¬Ù†Ø¨ Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙ†ÙØ³ÙŠ. Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù‡Ùˆ: " + guide.weight + " ØºØ±Ø§Ù….";
    } else if (safeAge <= 35) {
        return `Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙƒØ±. Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªÙØ¹Ø© ØªØ´ÙƒÙ„ Ø®Ø·Ø±Ø§Ù‹. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø­ÙˆÙ„ ${guide.temp}Â°Ù…. Ø±Ø§Ù‚Ø¨ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø§Ø¡Ø› Ø£ÙŠ Ø§Ù†Ø®ÙØ§Ø¶ Ù‚Ø¯ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ù…Ø´ÙƒÙ„Ø© ØµØ­ÙŠØ© Ø£Ùˆ Ø­Ø±Ø§Ø±ÙŠØ©.`;
    } else if (safeAge <= 45) { 
        return "Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù„Ù Ø¥Ù„Ù‰ ÙˆØ²Ù† ÙŠØªØ·Ù„Ø¨ Ø·Ø§Ù‚Ø© Ø£Ù‚Ù„. Ù‚Ù„Ù„ Ø§Ù„Ø¥Ø¬Ù‡Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·ÙŠÙˆØ± Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ (FCR) Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
    } else {
        return "Ø£ÙŠØ§Ù… Ø§Ù„Ø­ØµØ§Ø¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©: Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù„Ø­Ù… ÙˆØ§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø¯Ù‚Ø© ÙˆØªØ¬Ù†Ø¨ Ø£ÙŠ Ø¥Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ Ø£Ùˆ Ø¶ÙˆØ¶Ø§Ø¡. Ù…Ø¹Ø§Ù…Ù„ FCR Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: " + guide.fcr;
    }
}


document.addEventListener('DOMContentLoaded', () => {
    
    const resetButton = document.getElementById('reset-button');
    const dataEntryMessage = document.getElementById('data-entry-message');
    const flockAgeInput = document.getElementById('flock-age-input');
    const currentAgeDisplay = document.getElementById('current-age-display');
    const dailyTipsContent = document.getElementById('daily-tips-content');
    const dailyDataForm = document.getElementById('daily-data-form');
    const notesInput = document.getElementById('notes');
    const initialCountInputSection = document.getElementById('initial-count-section');
    const initialChickCountInput = document.getElementById('initial-chick-count');
    const actualWaterInput = document.getElementById('actual-water'); 
    const breederNameInput = document.getElementById('breeder-name'); 

    const aiModal = document.getElementById('ai-modal');
    const openAiModalBtn = document.getElementById('open-ai-modal-btn');
    const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
    const analyzeSymptomsBtn = document.getElementById('analyze-symptoms-btn');
    const symptomsInput = document.getElementById('symptoms-input');
    const imageInput = document.getElementById('image-input'); 
    const aiResultDiv = document.getElementById('ai-result');
    const analyzeBtnText = document.getElementById('analyze-btn-text');
    const analyzeLoader = document.getElementById('analyze-loader');
    
    const confirmResetModal = document.getElementById('confirm-reset-modal');
    const confirmResetBtn = document.getElementById('confirm-reset-btn');
    const cancelResetBtn = document.getElementById('cancel-reset-btn');

    const MAX_GUIDE_AGE = broilerGuideData.length - 1; 

    async function loadFlockDataFromServer(flockId) {
        // Ø§Ù„Ù…Ø³Ø§Ø± Ù…ÙˆØ­Ø¯
        const response = await fetch(`/api/flock/all-data`);
        if (!response.ok) {
            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${response.status}`);
        }
        const allData = await response.json();
        
        const flock = allData.find(f => f.flockId === flockId);
        return flock || null;
    }

    async function saveRecordToServer(record) {
        if (!record.flockId) {
            throw new Error("ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù‚Ø·ÙŠØ¹ (flockId) Ù„Ù„Ø­ÙØ¸.");
        }
        
        // Ø§Ù„Ù…Ø³Ø§Ø± Ù…ÙˆØ­Ø¯
        const response = await fetch(`/api/records/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(record)
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….");
        }

        return result; 
    }

    async function loadData() {
        if (!currentFlockId) return; 

        document.getElementById('breeder-name').value = currentBreederName;
        document.getElementById('current-breeder-display').textContent = `Ø§Ù„Ù…Ø±Ø¨ÙŠ: ${currentBreederName}`;
        
        try {
            const data = await loadFlockDataFromServer(currentFlockId);
            if (data) {
                flockData = {
                    ...DEFAULT_FLOCK_DATA,
                    ...data,
                    dailyRecords: data.dailyRecords || []
                };
                document.getElementById('initial-count-section').classList.add('hidden');
            } else {
                document.getElementById('initial-count-section').classList.remove('hidden');
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        }
        updateDashboard(flockData.currentAge);
    }
    
    function updateDashboard(ageInDays) {
        if (!flockData.startDate) return;
        
        const safeAge = Math.min(Math.max(0, ageInDays), MAX_GUIDE_AGE);
        flockData.currentAge = safeAge; 

        const guide = broilerGuideData[safeAge] || broilerGuideData[MAX_GUIDE_AGE];

        if (!flockData.initialChickCount || flockData.initialChickCount === 0) {
            initialCountInputSection.classList.remove('hidden');
            flockData.currentAge = 0; 
            flockAgeInput.value = 0;
            currentAgeDisplay.textContent = 0;
            initialChickCountInput.value = flockData.initialChickCount || ''; 
            dataEntryMessage.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù‚Ø·ÙŠØ¹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.";
            dataEntryMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
            dataEntryMessage.classList.add('text-indigo-600');
        } else {
            document.getElementById('initial-count-section').classList.add('hidden');
        }
        
        flockAgeInput.value = safeAge;
        currentAgeDisplay.textContent = safeAge;

        document.getElementById('target-temp').textContent = `${guide.temp}Â°`;
        document.getElementById('target-humidity').textContent = `${guide.humidity}%`;
        document.getElementById('target-weight').textContent = guide.weight; 
        document.getElementById('target-weight-grams').textContent = `${guide.weight} ØºØ±Ø§Ù…`;
        document.getElementById('target-daily-feed').textContent = `${guide.dailyFeed} ØºØ±Ø§Ù…`;
        document.getElementById('target-fcr').textContent = guide.fcr.toFixed(3); 

        dailyTipsContent.textContent = getDailyTips(safeAge);
        calculateAndDisplayMetrics(safeAge);

        const dayRecord = flockData.dailyRecords.find(r => r.day === safeAge);

        if(dayRecord){
            dataEntryMessage.textContent = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ${safeAge} Ù…Ø³Ø¬Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø£Ùˆ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ÙŠÙˆÙ… Ø¢Ø®Ø±.`;
            dataEntryMessage.classList.remove('hidden', 'text-red-600', 'text-indigo-600');
            dataEntryMessage.classList.add('text-green-600');

            document.getElementById('actual-feed').value = dayRecord.feedKg;
            document.getElementById('mortality-count').value = dayRecord.mortality;
            actualWaterInput.value = dayRecord.waterIntake || ''; 
            document.getElementById('actual-weight').value = dayRecord.avgWeight || '';
            notesInput.value = dayRecord.notes || ''; 

        } else if (flockData.initialChickCount) {
            dataEntryMessage.classList.add('hidden');
             document.getElementById('actual-feed').value = '';
             document.getElementById('mortality-count').value = '0';
             actualWaterInput.value = ''; 
             document.getElementById('actual-weight').value = '';
             notesInput.value = ''; 
        }
    }

    function calculateAndDisplayMetrics(upToAge) {
        const initialCount = flockData.initialChickCount || 0;
        if (initialCount === 0) { 
            document.getElementById('total-mortality-rate').textContent = `0.00%`;
            document.getElementById('actual-fcr').textContent = `0.000`; 
            document.getElementById('actual-cumulative-feed').textContent = `0.00`;
            return;
        }

        let totalMortality = 0;
        let totalFeedKg = 0;
        
        const recordsUpToDate = flockData.dailyRecords.filter(r => r.day <= upToAge);

        recordsUpToDate.forEach(record => {
            totalMortality += record.mortality;
            totalFeedKg += record.feedKg;
        });
        
        const currentCount = initialCount - totalMortality;

        const lastWeightRecord = [...recordsUpToDate]
            .filter(r => r.avgWeight !== null && r.avgWeight > 0)
            .pop();
        
        const currentAvgWeightGrams = lastWeightRecord ? lastWeightRecord.avgWeight : flockData.startWeight;
        const currentAvgWeightKg = (currentAvgWeightGrams / 1000); 

        const totalLiveWeightKg = currentAvgWeightKg * currentCount;
        const totalWeightGainKg = totalLiveWeightKg - (initialCount * (flockData.startWeight / 1000));
        
        let fcr = (totalWeightGainKg > 0) ? (totalFeedKg / totalWeightGainKg) : 0;
        
        const mortalityRate = (initialCount > 0) ? (totalMortality / initialCount) * 100 : 0;
        
        document.getElementById('total-mortality-rate').textContent = `${mortalityRate.toFixed(2)}%`;
        document.getElementById('actual-fcr').textContent = fcr.toFixed(3); 
        document.getElementById('actual-cumulative-feed').textContent = totalFeedKg.toFixed(2);
    }
    
    
    function setupApplication() {
        currentBreederName = localStorage.getItem('breederName');
        
        if (currentBreederName) {
            currentFlockId = createFlockId(currentBreederName);
            initialSetupModal.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            loadData();
        } else {
            initialSetupModal.classList.remove('hidden');
            dashboardScreen.classList.add('hidden');
        }
    }

    startAppBtn.onclick = () => {
        const name = initialBreederNameInput.value.trim();
        if (name.length < 3) {
            setupErrorMsg.classList.remove('hidden');
            return;
        }
        
        currentBreederName = name;
        currentFlockId = createFlockId(currentBreederName);
        localStorage.setItem('breederName', currentBreederName);

        setupErrorMsg.classList.add('hidden');
        initialSetupModal.classList.add('hidden');
        dashboardScreen.classList.remove('hidden'); 
        
        loadData();
    };

    document.getElementById('daily-data-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const age = flockData.currentAge;
        const breederName = document.getElementById('breeder-name').value.trim();
        const initialChickCount = parseInt(initialCountInputSection.classList.contains('hidden') ? 0 : initialChickCountInput.value) || 0; 
        const waterIntake = parseFloat(document.getElementById('actual-water').value) || 0; 
        const feedKg = parseFloat(document.getElementById('actual-feed').value) || 0;
        const mortality = parseInt(document.getElementById('mortality-count').value) || 0;
        const avgWeight = document.getElementById('actual-weight').value === '' ? null : parseFloat(document.getElementById('actual-weight').value);
        const notes = document.getElementById('notes').value.trim();

        if (!flockData.initialChickCount && initialChickCount <= 0) {
            dataEntryMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù‚Ø·ÙŠØ¹.';
            dataEntryMessage.classList.remove('hidden', 'text-green-600', 'text-indigo-600');
            dataEntryMessage.classList.add('text-red-600');
            setTimeout(() => { dataEntryMessage.classList.add('hidden'); }, 3000);
            return;
        }
        
        if (!breederName) {
            dataEntryMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø¨ÙŠ.';
            dataEntryMessage.classList.remove('hidden', 'text-green-600');
            dataEntryMessage.classList.add('text-red-600');
            setTimeout(() => { dataEntryMessage.classList.add('hidden'); }, 3000);
            return;
        }

        if (feedKg === 0 && mortality === 0 && waterIntake === 0 && (avgWeight === null || avgWeight === 0) && notes === '') {
            dataEntryMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ù„Ù Ø£Ùˆ ÙˆÙÙŠØ§Øª Ø£Ùˆ Ù…Ø§Ø¡ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª) Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ….';
            dataEntryMessage.classList.remove('hidden', 'text-green-600');
            dataEntryMessage.classList.add('text-red-600');
            setTimeout(() => { dataEntryMessage.classList.add('hidden'); }, 3000);
            return;
        }

        const recordToSend = { 
            flockId: currentFlockId, 
            day: age, 
            breederName, 
            initialChickCount: flockData.initialChickCount || initialChickCount, 
            waterIntake, 
            feedKg, 
            mortality, 
            avgWeight, 
            notes 
        };

        try {
            await saveRecordToServer(recordToSend); 
            await loadData(); 

            updateDashboard(age);
            dataEntryMessage.textContent = `âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ${age} Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±!`;
            dataEntryMessage.classList.remove('text-blue-600');
            dataEntryMessage.classList.add('text-green-600');

        } catch (error) {
            dataEntryMessage.textContent = `ğŸ›‘ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ${error.message}`;
            dataEntryMessage.classList.remove('text-blue-600', 'text-green-600');
            dataEntryMessage.classList.add('text-red-600');
        }
    });

    async function performReset() {
        localStorage.removeItem('breederName');
        currentFlockId = null;
        currentBreederName = null;
        flockData = {...DEFAULT_FLOCK_DATA, currentAge: 0, dailyRecords: []}; 

        confirmResetModal.classList.add('hidden');
        
        setupApplication();

        dataEntryMessage.textContent = `ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø¡.`;
        dataEntryMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');
        dataEntryMessage.classList.add('text-orange-600');
        setTimeout(() => { dataEntryMessage.classList.add('hidden'); }, 7000);
    }
    
    
    setupApplication(); 
});
</script>
</body>
</html>
